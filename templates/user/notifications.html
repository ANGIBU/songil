{# templates/user/notifications.html #}
{% extends "base.html" %}

{% block title %}알림 - 실종자 찾기 플랫폼{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
{% endblock %}

{% block content %}
<!-- 알림 헤더 -->
<section class="notifications-header">
    <div class="container">
        <div class="notifications-title">
            <h1><i class="fas fa-bell"></i> 알림</h1>
            <p>실종자 관련 업데이트와 중요한 소식을 확인하세요</p>
        </div>
        
        <!-- 알림 통계 -->
        <div class="notifications-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalNotifications">23</div>
                <div class="stat-label">전체 알림</div>
            </div>
            <div class="stat-item">
                <div class="stat-number unread" id="unreadNotifications">5</div>
                <div class="stat-label">읽지 않음</div>
            </div>
            <div class="stat-item">
                <div class="stat-number important" id="importantNotifications">2</div>
                <div class="stat-label">중요 알림</div>
            </div>
        </div>
        
        <!-- 알림 관리 도구 -->
        <div class="notifications-tools">
            <button class="tool-btn" onclick="markAllAsRead()">
                <i class="fas fa-check-double"></i>
                모두 읽음 처리
            </button>
            <button class="tool-btn" onclick="deleteReadNotifications()">
                <i class="fas fa-trash"></i>
                읽은 알림 삭제
            </button>
            <button class="tool-btn" onclick="toggleNotificationSettings()">
                <i class="fas fa-cog"></i>
                알림 설정
            </button>
        </div>
    </div>
</section>

<!-- 알림 필터 -->
<section class="notifications-filters">
    <div class="container">
        <div class="filter-tabs">
            <button class="filter-btn active" data-filter="all" onclick="filterNotifications('all')">
                <i class="fas fa-list"></i>
                전체 알림
                <span class="count">23</span>
            </button>
            <button class="filter-btn" data-filter="reports" onclick="filterNotifications('reports')">
                <i class="fas fa-file-alt"></i>
                내 신고 관련
                <span class="count">8</span>
            </button>
            <button class="filter-btn" data-filter="witnesses" onclick="filterNotifications('witnesses')">
                <i class="fas fa-eye"></i>
                목격 신고
                <span class="count">7</span>
            </button>
            <button class="filter-btn" data-filter="points" onclick="filterNotifications('points')">
                <i class="fas fa-coins"></i>
                포인트
                <span class="count">4</span>
            </button>
            <button class="filter-btn" data-filter="system" onclick="filterNotifications('system')">
                <i class="fas fa-megaphone"></i>
                공지사항
                <span class="count">4</span>
            </button>
        </div>
        
        <div class="filter-options">
            <select id="sortOrder" onchange="sortNotifications()">
                <option value="newest">최신순</option>
                <option value="oldest">오래된순</option>
                <option value="importance">중요도순</option>
            </select>
            <select id="readStatus" onchange="filterByReadStatus()">
                <option value="all">전체</option>
                <option value="unread">읽지 않음</option>
                <option value="read">읽음</option>
            </select>
        </div>
    </div>
</section>

<!-- 알림 목록 -->
<section class="notifications-list">
    <div class="container">
        <!-- 오늘 알림 -->
        <div class="notifications-section">
            <h3 class="section-title">
                <i class="fas fa-calendar-day"></i>
                오늘
            </h3>
            
            <div class="notification-item unread important" data-category="reports" data-id="1">
                <div class="notification-icon critical">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">실종자 발견 - 긴급</div>
                    <div class="notification-message">
                        신고하신 김○○님이 발견되었습니다. 현재 병원으로 이송 중이며 생명에는 지장이 없는 상태입니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">30분 전</span>
                        <span class="category">실종자 신고</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="viewReportDetail(1)">
                        <i class="fas fa-eye"></i>
                        상세보기
                    </button>
                    <button class="action-btn" onclick="markAsRead(1)">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="action-btn" onclick="deleteNotification(1)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item unread" data-category="witnesses" data-id="2">
                <div class="notification-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">목격 신고 승인</div>
                    <div class="notification-message">
                        박○○님에 대한 목격 신고가 승인되었습니다. 150포인트가 적립되었습니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">2시간 전</span>
                        <span class="category">목격 신고</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="viewWitnessDetail(2)">
                        <i class="fas fa-eye"></i>
                        상세보기
                    </button>
                    <button class="action-btn" onclick="markAsRead(2)">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="action-btn" onclick="deleteNotification(2)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item unread" data-category="points" data-id="3">
                <div class="notification-icon info">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">포인트 적립</div>
                    <div class="notification-message">
                        실종자 UP 버튼 클릭으로 10포인트가 적립되었습니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">4시간 전</span>
                        <span class="category">포인트</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn" onclick="markAsRead(3)">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="action-btn" onclick="deleteNotification(3)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item read" data-category="system" data-id="4">
                <div class="notification-icon announcement">
                    <i class="fas fa-megaphone"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">포인트샵 신상품 출시</div>
                    <div class="notification-message">
                        애플 에어팟 3세대가 한정 출시되었습니다. 선착순 10명에게만 제공됩니다!
                    </div>
                    <div class="notification-meta">
                        <span class="time">6시간 전</span>
                        <span class="category">공지사항</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="goToPointShop()">
                        <i class="fas fa-shopping-cart"></i>
                        포인트샵
                    </button>
                    <button class="action-btn" onclick="deleteNotification(4)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 어제 알림 -->
        <div class="notifications-section">
            <h3 class="section-title">
                <i class="fas fa-calendar-minus"></i>
                어제
            </h3>
            
            <div class="notification-item read" data-category="witnesses" data-id="5">
                <div class="notification-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">목격 신고 승인</div>
                    <div class="notification-message">
                        최○○님에 대한 목격 신고가 승인되었습니다. 300포인트가 적립되었습니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">어제 18:20</span>
                        <span class="category">목격 신고</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="viewWitnessDetail(5)">
                        <i class="fas fa-eye"></i>
                        상세보기
                    </button>
                    <button class="action-btn" onclick="deleteNotification(5)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item read" data-category="reports" data-id="6">
                <div class="notification-icon info">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">수사 진행 업데이트</div>
                    <div class="notification-message">
                        신고하신 김○○님 사건의 수사가 65% 진행되었습니다. CCTV 분석이 완료되었으며 목격자 조사가 진행 중입니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">어제 14:30</span>
                        <span class="category">실종자 신고</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="viewReportDetail(6)">
                        <i class="fas fa-eye"></i>
                        상세보기
                    </button>
                    <button class="action-btn" onclick="deleteNotification(6)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item unread important" data-category="system" data-id="7">
                <div class="notification-icon warning">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">새로운 긴급 실종자</div>
                    <div class="notification-message">
                        회원님 근처(강남구)에 8세 아동이 실종되었습니다. 즉시 주변을 살펴봐 주세요.
                    </div>
                    <div class="notification-meta">
                        <span class="time">어제 09:15</span>
                        <span class="category">공지사항</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="viewMissingPerson(7)">
                        <i class="fas fa-search"></i>
                        실종자 보기
                    </button>
                    <button class="action-btn" onclick="markAsRead(7)">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="action-btn" onclick="deleteNotification(7)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 이번 주 알림 -->
        <div class="notifications-section">
            <h3 class="section-title">
                <i class="fas fa-calendar-week"></i>
                이번 주
            </h3>
            
            <div class="notification-item read" data-category="points" data-id="8">
                <div class="notification-icon purchase">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">포인트샵 구매 완료</div>
                    <div class="notification-message">
                        스타벅스 아메리카노 기프티콘이 마이페이지에서 확인 가능합니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">5월 22일</span>
                        <span class="category">포인트</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="goToMyPage()">
                        <i class="fas fa-user"></i>
                        마이페이지
                    </button>
                    <button class="action-btn" onclick="deleteNotification(8)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item read" data-category="witnesses" data-id="9">
                <div class="notification-icon warning">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">목격 신고 반려</div>
                    <div class="notification-message">
                        제출하신 목격 신고가 정보 부족으로 반려되었습니다. 더 구체적인 정보로 다시 신고해 주세요.
                    </div>
                    <div class="notification-meta">
                        <span class="time">5월 21일</span>
                        <span class="category">목격 신고</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="resubmitWitnessReport(9)">
                        <i class="fas fa-redo"></i>
                        다시 신고
                    </button>
                    <button class="action-btn" onclick="deleteNotification(9)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notification-item read" data-category="system" data-id="10">
                <div class="notification-icon celebration">
                    <i class="fas fa-party-horn"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">회원가입을 환영합니다!</div>
                    <div class="notification-message">
                        실종자 찾기 플랫폼에 가입해 주셔서 감사합니다. 100포인트가 지급되었습니다.
                    </div>
                    <div class="notification-meta">
                        <span class="time">5월 20일</span>
                        <span class="category">공지사항</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn primary" onclick="startTutorial()">
                        <i class="fas fa-play"></i>
                        튜토리얼
                    </button>
                    <button class="action-btn" onclick="deleteNotification(10)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 더 이전 알림 -->
        <div class="notifications-section collapsed" id="olderNotifications">
            <h3 class="section-title collapsible" onclick="toggleSection('olderNotifications')">
                <i class="fas fa-calendar-alt"></i>
                더 이전 알림
                <i class="fas fa-chevron-down toggle-icon"></i>
            </h3>
            
            <div class="section-content">
                <!-- 추가 알림들이 여기에 표시됩니다 -->
                <div class="load-more-notifications">
                    <button class="btn btn-outline" onclick="loadMoreNotifications()">
                        <i class="fas fa-plus"></i>
                        더 많은 알림 보기
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 알림이 없을 때 -->
        <div class="no-notifications" id="noNotifications" style="display: none;">
            <div class="no-notifications-icon">
                <i class="fas fa-bell-slash"></i>
            </div>
            <h3>알림이 없습니다</h3>
            <p>새로운 알림이 오면 여기에 표시됩니다.</p>
        </div>
    </div>
</section>

<!-- 알림 설정 모달 -->
<div class="notification-settings-modal" id="notificationSettingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>알림 설정</h3>
            <button class="close-modal" onclick="closeNotificationSettings()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h4>알림 수신 방법</h4>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">브라우저 알림</div>
                        <div class="setting-description">웹사이트에서 직접 알림 받기</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="browserNotifications" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">이메일 알림</div>
                        <div class="setting-description">중요한 알림을 이메일로 받기</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="emailNotifications" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">SMS 알림</div>
                        <div class="setting-description">긴급 알림을 문자로 받기</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="smsNotifications">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4>알림 자동 삭제</h4>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">읽은 알림 자동 삭제</div>
                        <div class="setting-description">읽은 알림을 일정 기간 후 자동 삭제</div>
                    </div>
                    <select name="autoDeleteRead">
                        <option value="never">삭제 안함</option>
                        <option value="week">1주일 후</option>
                        <option value="month" selected>1개월 후</option>
                        <option value="3month">3개월 후</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeNotificationSettings()">취소</button>
            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                <i class="fas fa-save"></i>
                설정 저장
            </button>
        </div>
    </div>
</div>

<!-- 실시간 알림 토스트 -->
<div class="notification-toast" id="notificationToast">
    <div class="toast-icon">
        <i class="fas fa-bell"></i>
    </div>
    <div class="toast-content">
        <div class="toast-title">새 알림</div>
        <div class="toast-message">알림 내용이 여기에 표시됩니다</div>
    </div>
    <button class="toast-close" onclick="closeToast()">
        <i class="fas fa-times"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/user.js') }}"></script>
<script>
// 알림 페이지 JavaScript
let currentFilter = 'all';
let notifications = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeNotifications();
    requestNotificationPermission();
    startRealTimeNotifications();
});

// 알림 페이지 초기화
function initializeNotifications() {
    // 페이지 로드 애니메이션
    if (typeof gsap !== 'undefined') {
        gsap.from('.notifications-header', {
            duration: 0.8,
            y: -30,
            opacity: 0,
            ease: 'power2.out'
        });
        
        gsap.from('.notifications-stats .stat-item', {
            duration: 0.6,
            y: 20,
            opacity: 0,
            stagger: 0.1,
            delay: 0.2,
            ease: 'power2.out'
        });
        
        gsap.from('.notification-item', {
            duration: 0.5,
            x: -30,
            opacity: 0,
            stagger: 0.1,
            delay: 0.4,
            ease: 'power2.out'
        });
    }
    
    // 알림 데이터 로드
    loadNotifications();
}

// 브라우저 알림 권한 요청
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('알림 권한이 허용되었습니다.');
            }
        });
    }
}

// 실시간 알림 시작
function startRealTimeNotifications() {
    // 실제로는 WebSocket이나 Server-Sent Events 사용
    // 여기서는 데모용으로 랜덤 알림 생성
    setInterval(() => {
        if (Math.random() > 0.95) { // 5% 확률
            showNewNotification();
        }
    }, 10000); // 10초마다 체크
}

// 새 알림 표시
function showNewNotification() {
    const notifications = [
        {
            title: '새로운 목격 신고',
            message: '회원님이 관심 등록한 실종자에 대한 새로운 목격 정보가 접수되었습니다.',
            category: 'witnesses',
            importance: 'normal'
        },
        {
            title: '포인트 적립',
            message: '일일 출석으로 50포인트가 적립되었습니다.',
            category: 'points',
            importance: 'low'
        },
        {
            title: '긴급 실종자',
            message: '회원님 근처에 새로운 실종자가 신고되었습니다.',
            category: 'system',
            importance: 'high'
        }
    ];
    
    const randomNotification = notifications[Math.floor(Math.random() * notifications.length)];
    
    // 토스트 알림 표시
    showToast(randomNotification.title, randomNotification.message);
    
    // 브라우저 알림
    if (Notification.permission === 'granted') {
        new Notification(randomNotification.title, {
            body: randomNotification.message,
            icon: '/static/images/placeholder.jpg'
        });
    }
    
    // 페이지에 새 알림 추가
    addNotificationToPage(randomNotification);
}

// 토스트 알림 표시
function showToast(title, message) {
    const toast = document.getElementById('notificationToast');
    const titleEl = toast.querySelector('.toast-title');
    const messageEl = toast.querySelector('.toast-message');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    toast.classList.add('show');
    
    // 5초 후 자동 숨김
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
}

// 토스트 닫기
function closeToast() {
    document.getElementById('notificationToast').classList.remove('show');
}

// 알림 필터링
function filterNotifications(category) {
    currentFilter = category;
    
    // 필터 버튼 업데이트
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-filter="${category}"]`).classList.add('active');
    
    // 알림 아이템 필터링
    const notifications = document.querySelectorAll('.notification-item');
    notifications.forEach(notification => {
        if (category === 'all' || notification.dataset.category === category) {
            notification.style.display = 'block';
        } else {
            notification.style.display = 'none';
        }
    });
    
    // 애니메이션 효과
    if (typeof gsap !== 'undefined') {
        const visibleNotifications = document.querySelectorAll('.notification-item[style*="block"], .notification-item:not([style*="none"])');
        gsap.from(visibleNotifications, {
            duration: 0.4,
            x: -20,
            opacity: 0,
            stagger: 0.05,
            ease: 'power2.out'
        });
    }
}

// 알림 정렬
function sortNotifications() {
    const sortValue = document.getElementById('sortOrder').value;
    const container = document.querySelector('.notifications-list .container');
    const sections = Array.from(container.querySelectorAll('.notifications-section:not(.collapsed)'));
    
    sections.forEach(section => {
        const items = Array.from(section.querySelectorAll('.notification-item'));
        
        items.sort((a, b) => {
            switch(sortValue) {
                case 'oldest':
                    return new Date(a.dataset.time) - new Date(b.dataset.time);
                case 'importance':
                    const importanceA = a.classList.contains('important') ? 2 : (a.classList.contains('unread') ? 1 : 0);
                    const importanceB = b.classList.contains('important') ? 2 : (b.classList.contains('unread') ? 1 : 0);
                    return importanceB - importanceA;
                case 'newest':
                default:
                    return new Date(b.dataset.time) - new Date(a.dataset.time);
            }
        });
        
        items.forEach(item => section.appendChild(item));
    });
    
    // 정렬 애니메이션
    if (typeof gsap !== 'undefined') {
        gsap.from('.notification-item', {
            duration: 0.4,
            y: 10,
            opacity: 0,
            stagger: 0.03,
            ease: 'power2.out'
        });
    }
}

// 읽음 상태별 필터링
function filterByReadStatus() {
    const readStatus = document.getElementById('readStatus').value;
    const notifications = document.querySelectorAll('.notification-item');
    
    notifications.forEach(notification => {
        const isUnread = notification.classList.contains('unread');
        let show = true;
        
        if (readStatus === 'unread' && !isUnread) {
            show = false;
        } else if (readStatus === 'read' && isUnread) {
            show = false;
        }
        
        notification.style.display = show ? 'block' : 'none';
    });
}

// 알림을 읽음으로 표시
function markAsRead(notificationId) {
    const notification = document.querySelector(`[data-id="${notificationId}"]`);
    notification.classList.remove('unread');
    
    // 읽지 않은 알림 수 업데이트
    updateUnreadCount();
    
    if (window.showNotification) {
        window.showNotification('알림을 읽음으로 표시했습니다.', 'success');
    }
}

// 모든 알림을 읽음으로 표시
function markAllAsRead() {
    const unreadNotifications = document.querySelectorAll('.notification-item.unread');
    unreadNotifications.forEach(notification => {
        notification.classList.remove('unread');
    });
    
    updateUnreadCount();
    
    if (window.showNotification) {
        window.showNotification(`${unreadNotifications.length}개의 알림을 읽음으로 표시했습니다.`, 'success');
    }
}

// 알림 삭제
function deleteNotification(notificationId) {
    const notification = document.querySelector(`[data-id="${notificationId}"]`);
    
    if (typeof gsap !== 'undefined') {
        gsap.to(notification, {
            duration: 0.3,
            x: 100,
            opacity: 0,
            onComplete: () => {
                notification.remove();
                updateNotificationCounts();
            }
        });
    } else {
        notification.remove();
        updateNotificationCounts();
    }
}

// 읽은 알림 삭제
function deleteReadNotifications() {
    const readNotifications = document.querySelectorAll('.notification-item:not(.unread)');
    
    if (readNotifications.length === 0) {
        if (window.showNotification) {
            window.showNotification('삭제할 읽은 알림이 없습니다.', 'info');
        }
        return;
    }
    
    if (confirm(`${readNotifications.length}개의 읽은 알림을 삭제하시겠습니까?`)) {
        readNotifications.forEach((notification, index) => {
            setTimeout(() => {
                if (typeof gsap !== 'undefined') {
                    gsap.to(notification, {
                        duration: 0.2,
                        x: 100,
                        opacity: 0,
                        onComplete: () => {
                            notification.remove();
                            if (index === readNotifications.length - 1) {
                                updateNotificationCounts();
                            }
                        }
                    });
                } else {
                    notification.remove();
                    if (index === readNotifications.length - 1) {
                        updateNotificationCounts();
                    }
                }
            }, index * 50);
        });
        
        if (window.showNotification) {
            window.showNotification(`${readNotifications.length}개의 알림을 삭제했습니다.`, 'success');
        }
    }
}

// 알림 개수 업데이트
function updateNotificationCounts() {
    const totalNotifications = document.querySelectorAll('.notification-item').length;
    const unreadNotifications = document.querySelectorAll('.notification-item.unread').length;
    const importantNotifications = document.querySelectorAll('.notification-item.important').length;
    
    document.getElementById('totalNotifications').textContent = totalNotifications;
    document.getElementById('unreadNotifications').textContent = unreadNotifications;
    document.getElementById('importantNotifications').textContent = importantNotifications;
    
    // 필터 버튼 카운트 업데이트
    updateFilterCounts();
}

// 읽지 않은 알림 수 업데이트
function updateUnreadCount() {
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    document.getElementById('unreadNotifications').textContent = unreadCount;
}

// 필터 카운트 업데이트
function updateFilterCounts() {
    const categories = ['all', 'reports', 'witnesses', 'points', 'system'];
    
    categories.forEach(category => {
        let count;
        if (category === 'all') {
            count = document.querySelectorAll('.notification-item').length;
        } else {
            count = document.querySelectorAll(`.notification-item[data-category="${category}"]`).length;
        }
        
        const countElement = document.querySelector(`[data-filter="${category}"] .count`);
        if (countElement) {
            countElement.textContent = count;
        }
    });
}

// 섹션 토글
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const toggleIcon = section.querySelector('.toggle-icon');
    
    section.classList.toggle('collapsed');
    
    if (section.classList.contains('collapsed')) {
        toggleIcon.style.transform = 'rotate(0deg)';
    } else {
        toggleIcon.style.transform = 'rotate(180deg)';
    }
}

// 더 많은 알림 로드
function loadMoreNotifications() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 로딩 중...';
    btn.disabled = true;
    
    setTimeout(() => {
        // 더미 알림 추가
        const olderSection = document.getElementById('olderNotifications').querySelector('.section-content');
        
        for (let i = 0; i < 5; i++) {
            const notification = document.createElement('div');
            notification.className = 'notification-item read';
            notification.dataset.category = 'system';
            notification.dataset.id = Date.now() + i;
            
            notification.innerHTML = `
                <div class="notification-icon info">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">이전 알림 ${i + 1}</div>
                    <div class="notification-message">이전에 받은 알림 내용입니다.</div>
                    <div class="notification-meta">
                        <span class="time">${Math.floor(Math.random() * 30) + 1}일 전</span>
                        <span class="category">공지사항</span>
                    </div>
                </div>
                <div class="notification-actions">
                    <button class="action-btn" onclick="deleteNotification(${Date.now() + i})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            olderSection.insertBefore(notification, olderSection.lastElementChild);
        }
        
        // 애니메이션 효과
        if (typeof gsap !== 'undefined') {
            const newNotifications = olderSection.querySelectorAll('.notification-item:nth-last-child(-n+5)');
            gsap.from(newNotifications, {
                duration: 0.5,
                x: -30,
                opacity: 0,
                stagger: 0.1,
                ease: 'power2.out'
            });
        }
        
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        updateNotificationCounts();
        
        if (window.showNotification) {
            window.showNotification('새로운 알림을 불러왔습니다.', 'success');
        }
    }, 1000);
}

// 알림 설정 모달
function toggleNotificationSettings() {
    document.getElementById('notificationSettingsModal').style.display = 'flex';
}

function closeNotificationSettings() {
    document.getElementById('notificationSettingsModal').style.display = 'none';
}

function saveNotificationSettings() {
    // 설정 저장 로직
    closeNotificationSettings();
    
    if (window.showNotification) {
        window.showNotification('알림 설정이 저장되었습니다.', 'success');
    }
}

// 액션 버튼 핸들러들
function viewReportDetail(id) {
    window.location.href = `/missing/${id}`;
}

function viewWitnessDetail(id) {
    if (window.showNotification) {
        window.showNotification('목격 신고 상세 페이지로 이동합니다.', 'info');
    }
}

function viewMissingPerson(id) {
    window.location.href = `/missing/${id}`;
}

function goToPointShop() {
    window.location.href = '{{ url_for("pointshop") }}';
}

function goToMyPage() {
    window.location.href = '{{ url_for("mypage") }}';
}

function resubmitWitnessReport(id) {
    if (window.showNotification) {
        window.showNotification('목격 신고 재작성 페이지로 이동합니다.', 'info');
    }
}

function startTutorial() {
    if (window.showNotification) {
        window.showNotification('튜토리얼을 시작합니다.', 'info');
    }
}

// 페이지에 새 알림 추가
function addNotificationToPage(notificationData) {
    const todaySection = document.querySelector('.notifications-section:first-child');
    const newNotification = document.createElement('div');
    newNotification.className = `notification-item unread ${notificationData.importance === 'high' ? 'important' : ''}`;
    newNotification.dataset.category = notificationData.category;
    newNotification.dataset.id = Date.now();
    
    const iconClass = {
        'reports': 'fas fa-file-alt',
        'witnesses': 'fas fa-eye',
        'points': 'fas fa-coins',
        'system': 'fas fa-megaphone'
    };
    
    newNotification.innerHTML = `
        <div class="notification-icon ${notificationData.importance === 'high' ? 'critical' : 'info'}">
            <i class="${iconClass[notificationData.category]}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${notificationData.title}</div>
            <div class="notification-message">${notificationData.message}</div>
            <div class="notification-meta">
                <span class="time">방금 전</span>
                <span class="category">${getCategoryName(notificationData.category)}</span>
            </div>
        </div>
        <div class="notification-actions">
            <button class="action-btn" onclick="markAsRead(${Date.now()})">
                <i class="fas fa-check"></i>
            </button>
            <button class="action-btn" onclick="deleteNotification(${Date.now()})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // 첫 번째 위치에 추가
    todaySection.insertBefore(newNotification, todaySection.children[1]);
    
    // 애니메이션 효과
    if (typeof gsap !== 'undefined') {
        gsap.from(newNotification, {
            duration: 0.5,
            x: -50,
            opacity: 0,
            ease: 'power2.out'
        });
    }
    
    updateNotificationCounts();
}

// 카테고리 이름 반환
function getCategoryName(category) {
    const names = {
        'reports': '실종자 신고',
        'witnesses': '목격 신고',
        'points': '포인트',
        'system': '공지사항'
    };
    return names[category] || '기타';
}

// 알림 데이터 로드
function loadNotifications() {
    // 실제로는 서버에서 알림 데이터를 가져옴
    console.log('알림 데이터 로드 완료');
}

// 모달 외부 클릭시 닫기
document.getElementById('notificationSettingsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeNotificationSettings();
    }
});
</script>
{% endblock %}