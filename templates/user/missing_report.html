{# templates/user/missing_report.html #}
{% extends "base.html" %}

{% block title %}실종자 신고 - 실종자 찾기 플랫폼{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<!-- 신고 헤더 -->
<section class="report-header">
    <div class="container">
        <div class="report-title">
            <h1><i class="fas fa-plus-circle"></i> 실종자 신고</h1>
            <p>정확한 정보 입력이 실종자를 찾는데 큰 도움이 됩니다</p>
        </div>
        
        <!-- 진행률 표시 -->
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">기본정보</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">실종상황</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">사진업로드</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">연락처</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">최종확인</div>
                </div>
            </div>
            <div class="progress-line">
                <div class="progress-fill" style="width: 20%"></div>
            </div>
        </div>
        
        <!-- 긴급 안내 -->
        <div class="emergency-notice">
            <div class="notice-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="notice-content">
                <h3>긴급상황인가요?</h3>
                <p>즉시 112에 신고하신 후 이 양식을 작성해주세요</p>
                <a href="tel:112" class="emergency-call-btn">
                    <i class="fas fa-phone"></i>
                    112 신고하기
                </a>
            </div>
        </div>
    </div>
</section>

<!-- 신고 양식 -->
<section class="report-form-section">
    <div class="container">
        <form class="report-form" id="reportForm">
            <!-- 1단계: 기본정보 -->
            <div class="form-step active" data-step="1">
                <div class="step-header">
                    <h2>실종자 기본정보</h2>
                    <p>실종자의 기본적인 인적사항을 입력해주세요</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="missingName" class="required">
                            <i class="fas fa-user"></i>
                            성명
                        </label>
                        <input type="text" id="missingName" name="missingName" required placeholder="실명을 입력하세요">
                        <div class="error-message" id="missingNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="missingAge" class="required">
                            <i class="fas fa-birthday-cake"></i>
                            나이
                        </label>
                        <input type="number" id="missingAge" name="missingAge" required min="0" max="120" placeholder="만 나이">
                        <div class="error-message" id="missingAgeError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">
                            <i class="fas fa-venus-mars"></i>
                            성별
                        </label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="gender" value="male" required>
                                <span class="radio-custom"></span>
                                남성
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="gender" value="female" required>
                                <span class="radio-custom"></span>
                                여성
                            </label>
                        </div>
                        <div class="error-message" id="genderError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="height">
                            <i class="fas fa-ruler-vertical"></i>
                            키 (cm)
                        </label>
                        <input type="number" id="height" name="height" min="50" max="250" placeholder="예: 170">
                    </div>
                    
                    <div class="form-group">
                        <label for="weight">
                            <i class="fas fa-weight"></i>
                            체중 (kg)
                        </label>
                        <input type="number" id="weight" name="weight" min="10" max="200" placeholder="예: 65">
                    </div>
                    
                    <div class="form-group">
                        <label for="bodyType">
                            <i class="fas fa-user-circle"></i>
                            체형
                        </label>
                        <select id="bodyType" name="bodyType">
                            <option value="">선택하세요</option>
                            <option value="thin">마른체형</option>
                            <option value="normal">보통체형</option>
                            <option value="heavy">뚱뚱한체형</option>
                            <option value="muscular">근육질체형</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="physicalFeatures">
                        <i class="fas fa-eye"></i>
                        외모 특징
                    </label>
                    <textarea id="physicalFeatures" name="physicalFeatures" rows="3" placeholder="얼굴 특징, 머리 스타일, 흉터, 점 등 구체적인 외모 특징을 적어주세요"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                        다음 단계
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- 2단계: 실종상황 -->
            <div class="form-step" data-step="2">
                <div class="step-header">
                    <h2>실종 상황</h2>
                    <p>실종 당시의 상황을 자세히 알려주세요</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="missingDate" class="required">
                            <i class="fas fa-calendar"></i>
                            실종 날짜
                        </label>
                        <input type="date" id="missingDate" name="missingDate" required>
                        <div class="error-message" id="missingDateError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="missingTime">
                            <i class="fas fa-clock"></i>
                            실종 시간 (대략)
                        </label>
                        <input type="time" id="missingTime" name="missingTime">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="missingLocation" class="required">
                        <i class="fas fa-map-marker-alt"></i>
                        실종 장소
                    </label>
                    <input type="text" id="missingLocation" name="missingLocation" required placeholder="구체적인 주소나 장소명을 입력하세요">
                    <div class="location-help">
                        <button type="button" class="location-btn" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i>
                            현재 위치 사용
                        </button>
                    </div>
                    <div class="error-message" id="missingLocationError"></div>
                </div>
                
                <div class="form-group full-width">
                    <label for="clothing" class="required">
                        <i class="fas fa-tshirt"></i>
                        착용 의상
                    </label>
                    <textarea id="clothing" name="clothing" rows="3" required placeholder="상의, 하의, 신발, 가방 등 착용한 의상을 구체적으로 적어주세요&#10;예: 검은색 후드티, 청바지, 흰색 운동화"></textarea>
                    <div class="error-message" id="clothingError"></div>
                </div>
                
                <div class="form-group full-width">
                    <label for="situation">
                        <i class="fas fa-info-circle"></i>
                        실종 당시 상황
                    </label>
                    <textarea id="situation" name="situation" rows="4" placeholder="실종 전 상황, 마지막 목격 정보, 평소와 다른 행동 등을 자세히 적어주세요"></textarea>
                </div>
                
                <div class="form-group full-width">
                    <label for="medicalCondition">
                        <i class="fas fa-heartbeat"></i>
                        건강상태 / 복용약물
                    </label>
                    <textarea id="medicalCondition" name="medicalCondition" rows="2" placeholder="지병, 복용 중인 약물, 정신적 상태 등 (선택사항)"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                        <i class="fas fa-arrow-left"></i>
                        이전
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                        다음 단계
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- 3단계: 사진업로드 -->
            <div class="form-step" data-step="3">
                <div class="step-header">
                    <h2>실종자 사진</h2>
                    <p>선명한 사진일수록 목격자 신고에 도움이 됩니다</p>
                </div>
                
                <div class="photo-upload-section">
                    <div class="upload-area" id="photoUploadArea">
                        <div class="upload-placeholder">
                            <i class="fas fa-camera"></i>
                            <h3>사진을 업로드하세요</h3>
                            <p>드래그 앤 드롭 또는 클릭하여 선택</p>
                            <button type="button" class="btn btn-outline">
                                <i class="fas fa-plus"></i>
                                사진 선택
                            </button>
                            <input type="file" id="photoInput" name="photos" accept="image/*" multiple style="display: none;">
                        </div>
                    </div>
                    
                    <div class="uploaded-photos" id="uploadedPhotos">
                        <!-- 업로드된 사진들이 여기에 표시됩니다 -->
                    </div>
                    
                    <div class="upload-guidelines">
                        <h4>사진 업로드 가이드라인</h4>
                        <ul>
                            <li>• 얼굴이 선명하게 보이는 사진을 올려주세요</li>
                            <li>• 최근 사진일수록 좋습니다</li>
                            <li>• 여러 각도의 사진을 올리면 더욱 도움이 됩니다</li>
                            <li>• 지원 형식: JPG, PNG (최대 10MB)</li>
                            <li>• 최대 5장까지 업로드 가능합니다</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                        <i class="fas fa-arrow-left"></i>
                        이전
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep(4)">
                        다음 단계
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- 4단계: 연락처 -->
            <div class="form-step" data-step="4">
                <div class="step-header">
                    <h2>신고자 연락처</h2>
                    <p>수사 진행 상황을 알려드리기 위한 연락처입니다</p>
                </div>
                
                <div class="contact-info-notice">
                    <div class="notice-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <p>연락처는 수사기관에서만 사용되며, 절대 외부에 공개되지 않습니다.</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reporterName" class="required">
                            <i class="fas fa-user"></i>
                            신고자 성명
                        </label>
                        <input type="text" id="reporterName" name="reporterName" required placeholder="신고자의 실명">
                        <div class="error-message" id="reporterNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="relationship" class="required">
                            <i class="fas fa-heart"></i>
                            실종자와의 관계
                        </label>
                        <select id="relationship" name="relationship" required>
                            <option value="">선택하세요</option>
                            <option value="parent">부모</option>
                            <option value="child">자녀</option>
                            <option value="spouse">배우자</option>
                            <option value="sibling">형제/자매</option>
                            <option value="relative">친척</option>
                            <option value="friend">친구</option>
                            <option value="colleague">동료</option>
                            <option value="other">기타</option>
                        </select>
                        <div class="error-message" id="relationshipError"></div>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reporterPhone" class="required">
                            <i class="fas fa-phone"></i>
                            휴대폰 번호
                        </label>
                        <input type="tel" id="reporterPhone" name="reporterPhone" required placeholder="010-0000-0000">
                        <div class="error-message" id="reporterPhoneError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="emergencyPhone">
                            <i class="fas fa-phone-alt"></i>
                            비상 연락처
                        </label>
                        <input type="tel" id="emergencyPhone" name="emergencyPhone" placeholder="다른 가족 연락처 (선택)">
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="additionalInfo">
                        <i class="fas fa-plus-circle"></i>
                        추가 정보
                    </label>
                    <textarea id="additionalInfo" name="additionalInfo" rows="3" placeholder="수사에 도움이 될 만한 기타 정보가 있다면 적어주세요"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep(3)">
                        <i class="fas fa-arrow-left"></i>
                        이전
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep(5)">
                        다음 단계
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- 5단계: 최종확인 -->
            <div class="form-step" data-step="5">
                <div class="step-header">
                    <h2>신고 내용 확인</h2>
                    <p>입력하신 내용을 확인하고 신고를 완료해주세요</p>
                </div>
                
                <div class="confirmation-content">
                    <div class="confirm-section">
                        <h3>
                            <i class="fas fa-user"></i>
                            실종자 정보
                        </h3>
                        <div class="confirm-details" id="missingPersonSummary">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                    
                    <div class="confirm-section">
                        <h3>
                            <i class="fas fa-map-marker-alt"></i>
                            실종 상황
                        </h3>
                        <div class="confirm-details" id="missingSituationSummary">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                    
                    <div class="confirm-section">
                        <h3>
                            <i class="fas fa-camera"></i>
                            업로드된 사진
                        </h3>
                        <div class="confirm-photos" id="uploadedPhotosSummary">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                    
                    <div class="confirm-section">
                        <h3>
                            <i class="fas fa-phone"></i>
                            연락처 정보
                        </h3>
                        <div class="confirm-details" id="contactSummary">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                </div>
                
                <div class="final-agreements">
                    <div class="agreement-item">
                        <label class="checkbox-label">
                            <input type="checkbox" name="agreeAccuracy" required>
                            <span class="checkmark"></span>
                            위 정보는 사실이며, 허위 신고시 법적 책임을 질 수 있음을 이해합니다.
                        </label>
                    </div>
                    <div class="agreement-item">
                        <label class="checkbox-label">
                            <input type="checkbox" name="agreeProcess" required>
                            <span class="checkmark"></span>
                            신고 내용이 경찰청에 전달되어 공식 수사가 진행됨을 동의합니다.
                        </label>
                    </div>
                    <div class="agreement-item">
                        <label class="checkbox-label">
                            <input type="checkbox" name="agreePublic" required>
                            <span class="checkmark"></span>
                            개인정보 보호 처리 후 플랫폼에 공개됨을 동의합니다.
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep(4)">
                        <i class="fas fa-arrow-left"></i>
                        이전
                    </button>
                    <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                        <i class="fas fa-paper-plane"></i>
                        신고 접수하기
                    </button>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- 도움말 사이드바 -->
<div class="help-sidebar" id="helpSidebar">
    <div class="help-header">
        <h3>신고 도움말</h3>
        <button class="close-help" onclick="toggleHelpSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="help-content">
        <div class="help-item">
            <h4>신고 전 확인사항</h4>
            <ul>
                <li>• 112 신고 여부</li>
                <li>• 최근 연락 시도</li>
                <li>• 평소 행동 패턴 확인</li>
            </ul>
        </div>
        <div class="help-item">
            <h4>사진 촬영 팁</h4>
            <ul>
                <li>• 얼굴이 선명한 사진</li>
                <li>• 밝은 곳에서 촬영</li>
                <li>• 여러 각도 촬영</li>
            </ul>
        </div>
        <div class="help-item">
            <h4>긴급 연락처</h4>
            <ul>
                <li>• 경찰신고: 112</li>
                <li>• 소방서: 119</li>
                <li>• 실종아동센터: 182</li>
            </ul>
        </div>
    </div>
</div>

<!-- 도움말 플로팅 버튼 -->
<div class="floating-help">
    <button class="help-btn" onclick="toggleHelpSidebar()">
        <i class="fas fa-question-circle"></i>
        <span>도움말</span>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/user.js') }}"></script>
<script>
// 실종자 신고 페이지 JavaScript
let currentStep = 1;
let uploadedFiles = [];
let formData = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeReportForm();
    setupPhotoUpload();
    setupFormValidation();
});

// 신고 폼 초기화
function initializeReportForm() {
    // 오늘 날짜를 기본값으로 설정
    document.getElementById('missingDate').max = new Date().toISOString().split('T')[0];
    
    // 페이지 로드 애니메이션
    if (typeof gsap !== 'undefined') {
        gsap.from('.report-header', {
            duration: 0.8,
            y: -30,
            opacity: 0,
            ease: 'power2.out'
        });
        
        gsap.from('.form-step.active .form-group', {
            duration: 0.6,
            y: 20,
            opacity: 0,
            stagger: 0.1,
            delay: 0.3,
            ease: 'power2.out'
        });
    }
}

// 다음 단계로 이동
function nextStep(step) {
    if (!validateCurrentStep()) {
        return;
    }
    
    saveCurrentStepData();
    showStep(step);
}

// 이전 단계로 이동
function prevStep(step) {
    showStep(step);
}

// 단계 표시
function showStep(step) {
    // 단계 버튼 업데이트
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
            stepEl.classList.add('completed');
        } else if (index + 1 === step) {
            stepEl.classList.add('active');
        }
    });
    
    // 진행률 바 업데이트
    const progressFill = document.querySelector('.progress-fill');
    progressFill.style.width = (step / 5) * 100 + '%';
    
    // 폼 단계 표시
    document.querySelectorAll('.form-step').forEach(formStep => {
        formStep.classList.remove('active');
    });
    document.querySelector(`[data-step="${step}"]`).classList.add('active');
    
    currentStep = step;
    
    // 최종 확인 단계일 때 요약 생성
    if (step === 5) {
        generateSummary();
    }
    
    // 애니메이션 효과
    if (typeof gsap !== 'undefined') {
        gsap.from('.form-step.active', {
            duration: 0.5,
            x: 30,
            opacity: 0,
            ease: 'power2.out'
        });
    }
    
    // 페이지 상단으로 스크롤
    document.querySelector('.report-form-section').scrollIntoView({ behavior: 'smooth' });
}

// 현재 단계 유효성 검사
function validateCurrentStep() {
    switch(currentStep) {
        case 1:
            return validateStep1();
        case 2:
            return validateStep2();
        case 3:
            return validateStep3();
        case 4:
            return validateStep4();
        default:
            return true;
    }
}

// 1단계 유효성 검사
function validateStep1() {
    let isValid = true;
    
    const name = document.getElementById('missingName').value.trim();
    if (!name) {
        showFieldError('missingNameError', '성명을 입력해주세요.');
        isValid = false;
    }
    
    const age = document.getElementById('missingAge').value;
    if (!age || age < 0 || age > 120) {
        showFieldError('missingAgeError', '올바른 나이를 입력해주세요.');
        isValid = false;
    }
    
    const gender = document.querySelector('input[name="gender"]:checked');
    if (!gender) {
        showFieldError('genderError', '성별을 선택해주세요.');
        isValid = false;
    }
    
    return isValid;
}

// 2단계 유효성 검사
function validateStep2() {
    let isValid = true;
    
    const date = document.getElementById('missingDate').value;
    if (!date) {
        showFieldError('missingDateError', '실종 날짜를 입력해주세요.');
        isValid = false;
    }
    
    const location = document.getElementById('missingLocation').value.trim();
    if (!location) {
        showFieldError('missingLocationError', '실종 장소를 입력해주세요.');
        isValid = false;
    }
    
    const clothing = document.getElementById('clothing').value.trim();
    if (!clothing) {
        showFieldError('clothingError', '착용 의상을 입력해주세요.');
        isValid = false;
    }
    
    return isValid;
}

// 3단계 유효성 검사 (사진은 선택사항)
function validateStep3() {
    return true;
}

// 4단계 유효성 검사
function validateStep4() {
    let isValid = true;
    
    const reporterName = document.getElementById('reporterName').value.trim();
    if (!reporterName) {
        showFieldError('reporterNameError', '신고자 성명을 입력해주세요.');
        isValid = false;
    }
    
    const relationship = document.getElementById('relationship').value;
    if (!relationship) {
        showFieldError('relationshipError', '실종자와의 관계를 선택해주세요.');
        isValid = false;
    }
    
    const phone = document.getElementById('reporterPhone').value.trim();
    if (!phone || !validatePhoneNumber(phone)) {
        showFieldError('reporterPhoneError', '올바른 휴대폰 번호를 입력해주세요.');
        isValid = false;
    }
    
    return isValid;
}

// 현재 단계 데이터 저장
function saveCurrentStepData() {
    const currentStepEl = document.querySelector('.form-step.active');
    const inputs = currentStepEl.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        if (input.type === 'radio' || input.type === 'checkbox') {
            if (input.checked) {
                formData[input.name] = input.value;
            }
        } else {
            formData[input.name] = input.value;
        }
    });
}

// 사진 업로드 설정
function setupPhotoUpload() {
    const uploadArea = document.getElementById('photoUploadArea');
    const photoInput = document.getElementById('photoInput');
    
    // 클릭으로 파일 선택
    uploadArea.addEventListener('click', () => {
        photoInput.click();
    });
    
    // 파일 선택 처리
    photoInput.addEventListener('change', handleFileSelect);
    
    // 드래그 앤 드롭 처리
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });
}

// 파일 선택 처리
function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    handleFiles(files);
}

// 파일 처리
function handleFiles(files) {
    const validFiles = files.filter(file => {
        return file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024; // 10MB
    });
    
    if (uploadedFiles.length + validFiles.length > 5) {
        alert('최대 5장까지만 업로드 가능합니다.');
        return;
    }
    
    validFiles.forEach(file => {
        uploadedFiles.push(file);
        displayUploadedPhoto(file);
    });
    
    updateUploadArea();
}

// 업로드된 사진 표시
function displayUploadedPhoto(file) {
    const uploadedPhotos = document.getElementById('uploadedPhotos');
    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    
    const reader = new FileReader();
    reader.onload = (e) => {
        photoItem.innerHTML = `
            <img src="${e.target.result}" alt="업로드된 사진">
            <button class="remove-photo" onclick="removePhoto(${uploadedFiles.length - 1})">
                <i class="fas fa-times"></i>
            </button>
        `;
    };
    reader.readAsDataURL(file);
    
    uploadedPhotos.appendChild(photoItem);
}

// 사진 제거
function removePhoto(index) {
    uploadedFiles.splice(index, 1);
    const uploadedPhotos = document.getElementById('uploadedPhotos');
    uploadedPhotos.children[index].remove();
    updateUploadArea();
}

// 업로드 영역 업데이트
function updateUploadArea() {
    const uploadArea = document.getElementById('photoUploadArea');
    if (uploadedFiles.length >= 5) {
        uploadArea.style.display = 'none';
    } else {
        uploadArea.style.display = 'block';
    }
}

// 현재 위치 가져오기
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                // 실제로는 역지오코딩 API를 사용해 주소로 변환
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById('missingLocation').value = `위도: ${lat.toFixed(6)}, 경도: ${lng.toFixed(6)}`;
                
                if (window.showNotification) {
                    window.showNotification('현재 위치가 설정되었습니다.', 'success');
                }
            },
            (error) => {
                if (window.showNotification) {
                    window.showNotification('위치 정보를 가져올 수 없습니다.', 'error');
                }
            }
        );
    }
}

// 요약 생성
function generateSummary() {
    // 실종자 정보 요약
    const missingPersonSummary = document.getElementById('missingPersonSummary');
    missingPersonSummary.innerHTML = `
        <div class="summary-item">
            <strong>성명:</strong> ${formData.missingName || document.getElementById('missingName').value}
        </div>
        <div class="summary-item">
            <strong>나이/성별:</strong> ${formData.missingAge || document.getElementById('missingAge').value}세 / ${getGenderText()}
        </div>
        <div class="summary-item">
            <strong>신체:</strong> ${formData.height || document.getElementById('height').value || '미입력'}cm, ${getBodyTypeText()}
        </div>
        <div class="summary-item">
            <strong>특징:</strong> ${formData.physicalFeatures || document.getElementById('physicalFeatures').value || '없음'}
        </div>
    `;
    
    // 실종 상황 요약
    const missingSituationSummary = document.getElementById('missingSituationSummary');
    missingSituationSummary.innerHTML = `
        <div class="summary-item">
            <strong>실종일시:</strong> ${formData.missingDate || document.getElementById('missingDate').value} ${formData.missingTime || document.getElementById('missingTime').value || ''}
        </div>
        <div class="summary-item">
            <strong>실종장소:</strong> ${formData.missingLocation || document.getElementById('missingLocation').value}
        </div>
        <div class="summary-item">
            <strong>착용의상:</strong> ${formData.clothing || document.getElementById('clothing').value}
        </div>
        <div class="summary-item">
            <strong>상황:</strong> ${formData.situation || document.getElementById('situation').value || '미입력'}
        </div>
    `;
    
    // 연락처 요약
    const contactSummary = document.getElementById('contactSummary');
    contactSummary.innerHTML = `
        <div class="summary-item">
            <strong>신고자:</strong> ${formData.reporterName || document.getElementById('reporterName').value} (${getRelationshipText()})
        </div>
        <div class="summary-item">
            <strong>연락처:</strong> ${formData.reporterPhone || document.getElementById('reporterPhone').value}
        </div>
    `;
    
    // 업로드된 사진 요약
    const uploadedPhotosSummary = document.getElementById('uploadedPhotosSummary');
    uploadedPhotosSummary.innerHTML = uploadedFiles.length > 0 ? 
        `${uploadedFiles.length}장의 사진이 업로드되었습니다.` : 
        '업로드된 사진이 없습니다.';
}

// 폼 제출 처리
document.getElementById('reportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // 최종 동의 확인
    const agreements = document.querySelectorAll('.final-agreements input[type="checkbox"]');
    const allAgreed = Array.from(agreements).every(cb => cb.checked);
    
    if (!allAgreed) {
        if (window.showNotification) {
            window.showNotification('모든 동의사항에 체크해주세요.', 'error');
        }
        return;
    }
    
    // 로딩 상태
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 신고 접수 중...';
    submitBtn.disabled = true;
    
    try {
        // 폼 데이터 수집
        const finalFormData = new FormData();
        
        // 텍스트 데이터 추가
        Object.keys(formData).forEach(key => {
            finalFormData.append(key, formData[key]);
        });
        
        // 현재 단계 데이터도 추가
        saveCurrentStepData();
        Object.keys(formData).forEach(key => {
            finalFormData.append(key, formData[key]);
        });
        
        // 파일 데이터 추가
        uploadedFiles.forEach((file, index) => {
            finalFormData.append(`photo_${index}`, file);
        });
        
        // API 호출 시뮬레이션
        await simulateAPICall(3000);
        
        // 성공 처리
        showSuccessPage();
        
    } catch (error) {
        if (window.showNotification) {
            window.showNotification('신고 접수 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
        }
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// 성공 페이지 표시
function showSuccessPage() {
    const formSection = document.querySelector('.report-form-section .container');
    formSection.innerHTML = `
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>신고가 성공적으로 접수되었습니다</h2>
            <p>신고번호: <strong>#2024-${Date.now().toString().slice(-6)}</strong></p>
            
            <div class="next-steps">
                <h3>다음 단계</h3>
                <div class="step-list">
                    <div class="next-step">
                        <i class="fas fa-shield-alt"></i>
                        <span>1. 경찰청으로 자동 전달 (완료)</span>
                    </div>
                    <div class="next-step">
                        <i class="fas fa-user-check"></i>
                        <span>2. 관리자 검토 (1-2시간 소요)</span>
                    </div>
                    <div class="next-step">
                        <i class="fas fa-globe"></i>
                        <span>3. 플랫폼 공개 및 수색 시작</span>
                    </div>
                </div>
            </div>
            
            <div class="contact-info">
                <h3>중요 안내</h3>
                <ul>
                    <li>• 수사 진행 상황은 알림으로 안내드립니다</li>
                    <li>• 추가 정보가 필요시 연락드릴 수 있습니다</li>
                    <li>• 긴급상황시 즉시 112로 신고하세요</li>
                </ul>
            </div>
            
            <div class="action-buttons">
                <a href="${'{{ url_for("index") }}'}" class="btn btn-primary">
                    <i class="fas fa-home"></i>
                    홈으로 가기
                </a>
                <a href="${'{{ url_for("mypage") }}'}" class="btn btn-secondary">
                    <i class="fas fa-user"></i>
                    마이페이지
                </a>
            </div>
        </div>
    `;
    
    if (typeof gsap !== 'undefined') {
        gsap.from('.success-content', {
            duration: 0.8,
            y: 30,
            opacity: 0,
            ease: 'power2.out'
        });
    }
}

// 도움말 사이드바 토글
function toggleHelpSidebar() {
    const sidebar = document.getElementById('helpSidebar');
    sidebar.classList.toggle('active');
}

// 유틸리티 함수들
function getGenderText() {
    const gender = document.querySelector('input[name="gender"]:checked');
    return gender ? (gender.value === 'male' ? '남성' : '여성') : '미선택';
}

function getBodyTypeText() {
    const bodyType = document.getElementById('bodyType').value;
    const types = {
        'thin': '마른체형',
        'normal': '보통체형', 
        'heavy': '뚱뚱한체형',
        'muscular': '근육질체형'
    };
    return types[bodyType] || '미입력';
}

function getRelationshipText() {
    const relationship = document.getElementById('relationship').value;
    const relationships = {
        'parent': '부모',
        'child': '자녀',
        'spouse': '배우자',
        'sibling': '형제/자매',
        'relative': '친척',
        'friend': '친구',
        'colleague': '동료',
        'other': '기타'
    };
    return relationships[relationship] || '미선택';
}

function showFieldError(errorId, message) {
    const errorElement = document.getElementById(errorId);
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        
        const inputId = errorId.replace('Error', '');
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.classList.add('error');
        }
    }
}

function validatePhoneNumber(phone) {
    const phoneRegex = /^010-?\d{4}-?\d{4}$/;
    return phoneRegex.test(phone);
}

function simulateAPICall(delay = 1000) {
    return new Promise((resolve) => {
        setTimeout(resolve, delay);
    });
}

// 폼 유효성 검사 설정
function setupFormValidation() {
    // 실시간 유효성 검사
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            // 에러 상태 제거
            this.classList.remove('error');
            const errorId = this.id + 'Error';
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        });
    });
    
    // 휴대폰 번호 자동 포맷팅
    const phoneInputs = document.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach(input => {
        input.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length >= 11) {
                value = value.substring(0, 11);
                value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (value.length >= 7) {
                value = value.replace(/(\d{3})(\d{3,4})(\d{0,4})/, '$1-$2-$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})(\d{0,4})/, '$1-$2');
            }
            this.value = value;
        });
    });
}
</script>
{% endblock %}